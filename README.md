# Relationships between Images, Sound and Physical Controllers
## David Cardona – CS50 Final Project – Spring 2020


# Objective

Implement computer science concepts in the development of an art installation. The installation is dependent on establishing propper connections between all of the interacting mediums.


## Hardware

* A Computer running a Max patch, a Processing sketch, and serving as the main hub for Serial communication. The computer must have 4 available USB ports.
* An Arduino MEGA 2560 with a Button, a Potentiometer, and an Analog Joystick connected to it.
* An Arduino UNO that is used to send Serial from the Arduino MEGA 2560 into the computer via the Arduino SoftwareSerial library, and a digital pin connection between both of the Arduino boards.
* A eurorack modular synthesizer that accepts Control Voltage (CV) for sound generation and modulation.
* A Monome Crow module for eurorack. This is a scriptable Lua driven module that serves as a USB to CV to i2c interface. This project does not incorporate i2c. Although Lua driven, this project communicates with Crow via Max.
* A MIDI (Musical Instrument Digital Interface) synthesizer that has 5-pin DIN MIDI connectivity.
* It is necessary to have a MIDI connector soldered to jumper male cables in order to connect it to the Arduino pins.
* An audio interface to bring audio back into the computer as an analog signal.
* Optinally, an analog mixer to balance audio signals prior to sending them into the audio interface.


## Software

* [Arduino IDE](https://www.arduino.cc/en/software)
* [Processing 3](https://processing.org/download) -- Processing 4 may also work but it has not yet been tested. --
* [Max 8](https://cycling74.com/downloads)
* [The Max library for Crow](https://github.com/monome/crow-max-and-m4l/releases/tag/rev210630), created and developed by Monome.
* [The bonk~ object](https://github.com/v7b1/bonk_64bit-version/releases), created by Miller Puckette for PureData, and adapted to Max by Volker Böhm
* [The OscP5 library](http://www.sojamo.de/libraries/oscP5/), created by Andreas Schlegel


## Delivery mediums

The delivery mediums for the installation include audio and video.

The audio is generated by pulses sent out from Crow to trigger analog synthesizers. These pulses are created in Max by a metro object that generates pulses at a specified rate. A pulse consist of a 5V square wave signal of a very short duration.

The graphics consist of an ellipse that changes size and color based on the amplitude of the incoming signal. The size is dependent on amplitude changes, and the colors will be semi-randomly generated based on the transient information of the incoming audio. The brightness of the color will depend on computing the randomly generated RGB values against the amplitude of the signal, so that the louder the audio signal, the brighter the colors.

The software records Max's incoming audio into a wave file, and render png images that correspond to the frames Processing generates. These files can be imported into a video editing software to render a video file of the performance.

The Monome Crow module has 4 available outputs. I am using Crow's output 1 to trigger a melodic line. Output 2 trigger a secondary melodic line that is offset by an eigth note. Output 3 activates a parameter in the Eurorack synthesizer that enhances the melodic line that comes from output 1 while the sequence is running. Output 4 activates a clock that creates subdivisions to trigger drums.

A Moog Sub37 is being triggered by the MIDI triggered by the Arduino Joystick.


# INSTRUCTIONS


## Setup: Hardware

### Arduino

1. Connect a joystick, a button, a potentiometer, and a MIDI connector into the Arduino MEGA 2560, according to the following diagrams and tutorials:
    * [Joystick](https://www.brainy-bits.com/arduino-joystick-tutorial/)
    * [Button](https://www.arduino.cc/en/tutorial/button)
    * [Potentiometer](https://www.arduino.cc/en/tutorial/AnalogInput)
    * [MIDI connector](https://learn.sparkfun.com/tutorials/midi-tutorial/hardware--electronic-implementation)

    Connect the devices to the following pins:
    * Joystick SW pin to PWM (Pulse Width Modulation) pin 2.
    * Joystick VRx to Analog In pin A0.
    * Joystick VRy to Analog In pin A1.
    * Potentiometer to Analon In pin A2.
    * Button to PWM pin 3.
    * MIDI connector to Communication pin TX1 18.
    Make sure that all circuits are properly connected to Arduino's 5V and Ground (GND).

2. Connect an additional cable coming from Arduino MEGA 2560 pin TX2 16, and going into Arduino UNO Digital PWM pin 2. This is so that a Software Serial connection can be established between both Arduino's using Arduino's Software Serial library. This is necessary because the Joystick information is going to be sent to two different programs inside the computer (Max and Processing). Serial communication is a one to one communication, making the port that is used for one application unable for the other application. This is despite the fact that the Arduino MEGA 2560 board has 4 serial ports on board, because the only serial port that can directly speak to the computer via USB is the default connection. This serial connection is broken if cables are connected to the TX0 1 and RX 0 0 pins.

*As an additional note, since both Arduinos are going to be connected to the computer via USB, it is not necessary to connect the Ground pin of the Arduino UNO to the ground pin of the breadboard. Grounding for the circuit will be supplied by the USB connection.*

3. Once the physical connections are in place, make sure both boards are connected to the computer via USB.


### Arduino MEGA 2560 – Software

1. Open the provided [ArduinoMEGA_Main.ino](https://github.com/dcardonab/relationships_between_images_sound_and_physical_controllers/blob/master/ArduinoMEGA_Main/ArduinoMEGA_Main.ino) script.

2. In the toolbar, go to 'Tools' > 'Board' > 'Arduino Mega or Mega 2560' to configure the IDE to send information to the MEGA 2560 board.

3. In the toolbar, go to 'Tools' > 'Port' > '/dev/cu.usbmodem###### (Arduino Mega or Mega 2560)'. The hash symbols will be the identifier of the connected device. This connection will ensure that the code will be uploaded to the device connected to the selected port.

4. Upload script to board with the arrow button at the top of Arduino's IDE window.


### Arduino UNO – Software

1. Open the provided [ArduinoUNO_SerialThruPort.ino](https://github.com/dcardonab/relationships_between_images_sound_and_physical_controllers/blob/master/ArduinoUNO_SerialThruPort/ArduinoUNO_SerialThruPort.ino) script.

2. In the toolbar, go to 'Tools' > 'Board' > 'Arduino Uno' to configure the IDE to send information to the UNO board.

3. In the toolbar, go to 'Tools' > 'Port' > '/dev/cu.usbmodem######' (Arduino Uno)'. The hash symbols will be the identifier of the connected device. This connection will ensure that the code will be uploaded to the device connected to the selected port.

4. Upload script to board with the arrow button at the top of Arduino's IDE window.


### Audio

1. Connect Monome Crow module to computer via USB. Information will be sent from Max (computer) to Crow through a serial connection. Crow will convert the information into CV that it can use to control parameters of the modular analog synthesizer.

2. Connect MIDI synthesizer 5-pin DIN input to Arduino MEGA 2560 via a USB cable. The synthesizer will be receiving MIDI information from Arduino's second serial port (TX1 18).

3. Connect the audio output of the synthesizers to an audio interface in order to bring the audio back into the computer.

4. Connect the audio interface to the computer via USB.


## Setup: Software

### Processing

1. Make sure Processing version 3 is installed.

2. Make sure the OscP5 library is installed to enable communication between Max and Processing via UDP.

4. Open the provided [Processing_audioGraphics.pde](https://github.com/dcardonab/relationships_between_images_sound_and_physical_controllers/blob/master/Processing_AudioGraphics/Processing_AudioGraphics.pde) sketch in Processing.

5. Run the sketch by pressing the button in the top left of the Processing window.

6. Refer to the terminal to determine which port corresponds to the Arduino UNO '/cu' serial port. Note that '/tty' will also be available, but this project uses '/cu' for all Serial connections.

7. To ensure that the right port is connected for the Serial transfer, in the setup() function, change the hash to the value of correct USB port:
    * String portName = Serial.list()[#];

8. Once step 9 of the Max section below has been completed, rerun the Processing sketch.


### Max

1. Make sure Max 8 is installed.

2. Make sure the Crow Max library is installed.

3. Make sure the 64-bit version of the bonk~ object for Max is installed.

4. Open the provided [Max_Host.maxpat](https://github.com/dcardonab/relationships_between_images_sound_and_physical_controllers/tree/master/Max_Host) patch in Max.

5. Click on the 'Print Serial Ports to Max Console' button, and go to the Max Console to identify which port corresponds to the Arduino MEGA 2560 USB serial port.

6. Use the 'Select Serial Port' drop-down menu to select Arduino MEGA 2560's port.

7. Click on the 'Initiate' button. This will open a floating window with a drop-down menu from where Crow's USB port can be Selected. The 'Confirmation' button will blink to verify connection.

8. Click on the 'Verify' button. The Max Console will print a message that reads Connected.

9. Use the 'Set Outputs to Pulse' drop-down menu to enable Crow's outputs 1, 2, and 4 to output a 5V pulse signal, which is used as a trigger/gate in modular analog synthesis.

**Now, go back to Processing and run the sketch.**

10. In the toolbar, go to 'Options' > 'Audio Status...' and verify that the correct audio interface is selected for on the 'Input Device' field.

11. Click on the 'Create File' button to create an audio file that will store the audio coming in from the interface while the installation sequence is running. This file will be stored in the same directory as the 'Max_Host.maxpat' patch.

12. Click on the 'Set Default Settings' to initialize the audio file in stereo (2 audio channels), at a sample rate of 48000kHz, and a bit depth resolution of 24 bits.

13. Activate the 'Start/Stop Serial' toggle by clicking on it. This will initiate the data transfer between the Arduino MEGA 2560 and Max.

14. Click on the 'Start/Stop Audio' button to start running audio in Max.


# Controls

## Physical Controls

### Arduino Button

* Start and Stop the Max audio sequence by instructing Crow to send out regular pulses from outputs 1, 2, and 4. These pulses will generate audio by triggering the Analog Synthesizers.
    
* The pulse in output 2 has an offset of half the rate of the pulses. Assuming each pulse is a quarter note, the offset will create an eigth note displacement against the original pulse when triggering to the instrument triggered by this output.

* Output 3 is a 5V gate that opens and closes when the button is pressed. I used it to activate a parameter in the modular synthesizer that modifies the signal while the instrument is playing. This parameter is deactivated when the instrument is not playing to prevent feedback loops.


### Arduino Potentiometer

* Controls the rate at which Max sends out pulses, which makes it a tempo control.


### Arduino Joystick

* Pressing the Joystick's switch/clicker down will trigger the MIDI analog synthesizer. The note it sends out can be changed inside of the 'Arduino_Main.ino' sketch.

* Pressing the Joystick's switch/clicker will also swap the colors of the ellipse and the background being drawn in Processing.

* Moving the Joystick's X axis will control the octave parameter of the oscillators of a Moog Sub37 synthesizer.

* Moving the Joystick's Y axis will control the waveshape of the oscillators, and the Multidrive saturation of the filter of a Moog Sub37 synthesizer.

* Moving the Joystick's X and Y axis will also respectively control the X and Y axes positioning of the ellipse drawn in Processing.


## Digital Controls

### Max

* Max includes Bypass buttons for each of Crow's output channels to control which instruments are being triggered by the pulses generated by the metro object. It also includes a button to bypass the graphics by interrupting the UDP serial stream that is output from Max to Processing.


### Processing
* Once a recording has been started (see Rendering below), the 'r' key of the keyboard can be used to stop (and then restart) the recording.


# Rendering

## Max

* If a file is created (via the 'Create File' button in the Max patch), Max will render a stereo audio file at a sample rato of 48000kHz, and a bit depth resolution of 24 bits. This file will be stored in the 'Max_Host' folder.


## Processing

* Processing will start rendeing png frames of the canvas (Processing drawing window) once it receives an amplitude to analyze, meaning that audio and video recording will start at the same time.

* This is the only way to initiate a first recording in the included Processing patch. However, the patch is set so that the 'r' key can be used to stop and restart recording after that first recording has begun.

* Processing will export the rendered frames to a folder named 'framesOut'. The numbering of these frames will be sequential and dependent on the executed number of iterations of Processing's draw() function (this value is know in Processing as frameCount).

* These frames can then be imported into a Video Editor (like Premiere, or After Effects) to build the movie from frames. Audio can be imported too, synchronized, and exported as a standard video file (e.g., mov file). This file serves as a record of the performance, and can be used in video players, as well as in any other traditional usage methods for video.
